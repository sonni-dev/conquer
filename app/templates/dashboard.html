{% extends "base.html" %}

{% block title %}Dashboard - Conquer{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Progress Section -->
    <div class="progress-section">
        <div class="level-card">
            <div class="level-badge">
                <span class="level-number">{{ user.current_level }}</span>
                <span class="level-label">Level</span>
            </div>
            <div class="xp-container">
                <div class="xp-bar-bg">
                    <div class="xp-bar-fill" style="width: {{ user.xp_progress_percent() }}%"></div>
                </div>
                <div class="xp-text">{{ user.total_xp % 100 }} / 100 XP</div>
                <div class="xp-next">{{ user.xp_for_next_level() }} XP to Level {{ user.current_level + 1 }}</div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ”¥</div>
                <div class="stat-value">{{ user.current_streak }}</div>
                <div class="stat-label">Day Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ†</div>
                <div class="stat-value">{{ user.longest_streak }}</div>
                <div class="stat-label">Best Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-value">{{ user.tasks_completed }}</div>
                <div class="stat-label">Total Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“…</div>
                <div class="stat-value">{{ weekly_completions }}</div>
                <div class="stat-label">This Week</div>
            </div>
        </div>
    </div>

    <!-- Category Balance -->
    <div class="category-section">
        <h2>ğŸ“Š Life Balance (This Week)</h2>
        <p class="subtitle">Tasks completed in each category</p>
        <div class="category-grid">
            {% for category in categories %}
            <div class="category-card">
                <div class="category-name">{{ category }}</div>
                <div class="category-count">{{ category_stats.get(category, 0) }}</div>
                <div class="category-bar-bg">
                    {% set max_count = category_stats.values()|max if category_stats.values()|list else 1 %}
                    {% set percentage = (category_stats.get(category, 0) / max_count * 100) if max_count > 0 else 0 %}
                    <div class="category-bar-fill" style="width: {{ percentage }}%"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Active Tasks -->
    {% if active_tasks %}
    <div class="active-tasks-section">
        <h2>ğŸ“‹ Today's Active Quests</h2>
        <div class="task-instances-list">
            {% for instance in active_tasks %}
            {% set status = instance.get_completion_status() %}
            <div class="task-instance-card">
                <div class="instance-header">
                    <div class="instance-title-area">
                        <h3>{{ instance.template.title }}</h3>
                        <span class="instance-category">{{ instance.template.category }}</span>
                    </div>
                    <div class="instance-tier-badge tier-{{ instance.selected_tier }}">
                        {% if instance.selected_tier == 3 %}
                        ğŸ”¥ High
                        {% elif instance.selected_tier == 2 %}
                        âš¡ Medium
                        {% else %}
                        ğŸŒ™ Low
                        {% endif %}
                    </div>
                </div>
                
                <div class="instance-progress">
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: {{ status.percentage }}%"></div>
                    </div>
                    <span class="progress-text">{{ status.completed }} / {{ status.total }} subtasks</span>
                </div>
                
                <div class="instance-actions">
                    <a href="{{ url_for('task_detail', instance_id=instance.id) }}" class="btn-primary">
                        Continue Quest
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Completed Tasks Today -->
    {% if completed_tasks %}
    <div class="completions-section">
        <h2>âœ¨ Completed Today</h2>
        <div class="completions-list">
            {% for instance in completed_tasks %}
            {% set status = instance.get_completion_status() %}
            <div class="completion-item">
                <span class="completion-check">âœ“</span>
                <div class="completion-info">
                    <span class="completion-title">{{ instance.template.title }}</span>
                    <span class="completion-category">{{ instance.template.category }}</span>
                    <span class="completion-subtasks">{{ status.completed }}/{{ status.total }} subtasks</span>
                </div>
                <div class="completion-meta">
                    {% if instance.selected_tier == 3 %}
                    <span class="tier-badge high">ğŸ”¥ High</span>
                    {% elif instance.selected_tier == 2 %}
                    <span class="tier-badge medium">âš¡ Medium</span>
                    {% else %}
                    <span class="tier-badge low">ğŸŒ™ Low</span>
                    {% endif %}
                    <span class="completion-points">+{{ instance.xp_earned }} XP</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Quick Add -->
    <div class="quick-add-section">
        <h2>â• Add Quest to Today</h2>
        <p class="subtitle">Pick a template and choose your energy level</p>
        <a href="{{ url_for('templates_list') }}" class="btn-primary btn-large">
            Browse Templates
        </a>
    </div>
</div>

<div id="notification" class="notification"></div>
{% endblock %}
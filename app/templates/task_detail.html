{% extends "base.html" %}

{% block title %}{{ instance.template.title }} - Conquer{% endblock %}

{% block content %}
<div class="task-detail-page">
    <div class="task-detail-header">
        <div>
            <h1>{{ instance.template.title }}</h1>
            <span class="task-category-badge">{{ instance.template.category }}</span>
        </div>
        <div class="task-tier-badge tier-{{ instance.selected_tier }}">
            {% if instance.selected_tier == 3 %}
            ðŸ”¥ High Energy
            {% elif instance.selected_tier == 2 %}
            âš¡ Medium Energy
            {% else %}
            ðŸŒ™ Low Energy
            {% endif %}
        </div>
    </div>

    {% set status = instance.get_completion_status() %}
    
    <!-- Progress Bar -->
    <div class="task-progress-section">
        <div class="progress-info">
            <span class="progress-label">Progress</span>
            <span class="progress-count">{{ status.completed }} / {{ status.total }}</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: {{ status.percentage }}%"></div>
        </div>
    </div>

    <!-- Subtasks Checklist -->
    <div class="subtasks-section">
        <h2>ðŸ“‹ Checklist</h2>
        <div class="subtasks-list">
            {% for completion in instance.subtask_completions %}
            <div class="subtask-item {% if completion.completed %}completed{% endif %}" 
                 onclick="toggleSubtask({{ instance.id }}, {{ completion.id }})">
                <div class="checkbox-wrapper">
                    <input type="checkbox" 
                           id="subtask-{{ completion.id }}" 
                           {% if completion.completed %}checked{% endif %}
                           onclick="event.stopPropagation()">
                    <label for="subtask-{{ completion.id }}"></label>
                </div>
                <div class="subtask-content">
                    <span class="subtask-text">{{ completion.subtask.description }}</span>
                    <span class="subtask-level-badge level-{{ completion.subtask.level }}">
                        L{{ completion.subtask.level }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Upgrade Option -->
    {% if instance.can_upgrade_tier() and instance.selected_tier < 3 %}
    <div class="upgrade-section">
        <div class="upgrade-card">
            <div class="upgrade-icon">ðŸŽ‰</div>
            <div class="upgrade-content">
                <h3>All done! Feeling good?</h3>
                <p>You completed all {{ status.total }} subtasks! Want to upgrade to 
                {% if instance.selected_tier == 1 %}Medium{% else %}High{% endif %} 
                Energy and tackle more?</p>
            </div>
            <button class="btn-upgrade" onclick="upgradeTier({{ instance.id }})">
                {% if instance.selected_tier == 1 %}
                Upgrade to âš¡ Medium Energy
                {% else %}
                Upgrade to ðŸ”¥ High Energy
                {% endif %}
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="task-actions-section">
        {% if not instance.is_completed %}
            {% if status.percentage >= 50 %}
            <button class="btn-primary btn-large" onclick="completeTask({{ instance.id }})">
                âœ“ Complete Quest
            </button>
            {% else %}
            <button class="btn-primary btn-large" disabled title="Complete at least 50% of subtasks">
                âœ“ Complete Quest ({{ status.completed }}/{{ status.total }} done)
            </button>
            {% endif %}
            <button class="btn-danger" onclick="deleteTask({{ instance.id }})">
                Remove Task
            </button>
        {% else %}
            <div class="completed-banner">
                âœ¨ Quest Completed! +{{ instance.xp_earned }} XP
            </div>
        {% endif %}
        <a href="{{ url_for('dashboard') }}" class="btn-secondary">
            Back to Dashboard
        </a>
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
function toggleSubtask(instanceId, completionId) {
    fetch(`/task/${instanceId}/toggle-subtask/${completionId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload to update UI
            window.location.reload();
        } else {
            showNotification('Error updating subtask', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating subtask', 'error');
    });
}

function upgradeTier(instanceId) {
    if (!confirm('Upgrade to next energy tier and add more subtasks?')) {
        return;
    }

    fetch(`/task/${instanceId}/upgrade-tier`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error upgrading tier', 'error');
    });
}

function completeTask(instanceId) {
    if (!confirm('Mark this quest as complete?')) {
        return;
    }

    fetch(`/task/${instanceId}/complete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("dashboard") }}';
            }, 2000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error completing task', 'error');
    });
}

function deleteTask(instanceId) {
    if (!confirm('Remove this task? (Cannot be undone)')) {
        return;
    }

    fetch(`/task/${instanceId}/delete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("dashboard") }}';
            }, 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting task', 'error');
    });
}
</script>
{% endblock %}
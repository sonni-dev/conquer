{% extends "base.html" %}

{% block title %}{{ instance.template.title }} - Conquer{% endblock %}

{% block content %}
<div class="task-detail-page">
    <div class="task-detail-header">
        <div>
            <h1>{{ instance.template.title }}</h1>
            <span class="task-category-badge">{{ instance.template.category }}</span>
        </div>
        <div class="task-tier-badge tier-{{ instance.selected_tier }}">
            {% if instance.selected_tier == 3 %}
            ðŸ”¥ High Energy
            {% elif instance.selected_tier == 2 %}
            âš¡ Medium Energy
            {% else %}
            ðŸŒ™ Low Energy
            {% endif %}
        </div>
    </div>

    {% set status = instance.get_completion_status() %}
    
    <!-- Progress Bar -->
    <div class="task-progress-section">
        <div class="progress-info">
            <span class="progress-label">Progress</span>
            <span class="progress-count">{{ status.completed }} / {{ status.total }}</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: {{ status.percentage }}%"></div>
        </div>
    </div>

    <!-- Subtasks Checklist -->
    <div class="subtasks-section">
        <h2>ðŸ“‹ Checklist</h2>
        <div class="subtasks-list">
            {% for completion in instance.subtask_completions %}
            <form method="POST" action="{{ url_for('toggle_subtask', instance_id=instance.id, completion_id=completion.id) }}" class="subtask-form">
                <div class="subtask-item {% if completion.completed %}completed{% endif %}">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" 
                               id="subtask-{{ completion.id }}" 
                               {% if completion.completed %}checked{% endif %}
                               onchange="this.form.submit()">
                        <label for="subtask-{{ completion.id }}"></label>
                    </div>
                    <div class="subtask-content">
                        <span class="subtask-text">{{ completion.subtask.description }}</span>
                        <span class="subtask-level-badge level-{{ completion.subtask.level }}">
                            L{{ completion.subtask.level }}
                        </span>
                    </div>
                </div>
            </form>
            {% endfor %}
        </div>
    </div>

    <!-- Upgrade Option -->
    {% if instance.can_upgrade_tier() and instance.selected_tier < 3 %}
    <div class="upgrade-section">
        <div class="upgrade-card">
            <div class="upgrade-icon">ðŸŽ‰</div>
            <div class="upgrade-content">
                <h3>All done! Feeling good?</h3>
                <p>You completed all {{ status.total }} subtasks! Want to upgrade to 
                {% if instance.selected_tier == 1 %}Medium{% else %}High{% endif %} 
                Energy and tackle more?</p>
            </div>
            <form method="POST" action="{{ url_for('upgrade_tier', instance_id=instance.id) }}">
                <button type="submit" class="btn-upgrade">
                    {% if instance.selected_tier == 1 %}
                    Upgrade to âš¡ Medium Energy
                    {% else %}
                    Upgrade to ðŸ”¥ High Energy
                    {% endif %}
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="task-actions-section">
        {% if not instance.is_completed %}
            {% if status.percentage >= 50 %}
            <form method="POST" action="{{ url_for('complete_task', instance_id=instance.id) }}" style="display: inline;">
                <button type="submit" class="btn-primary btn-large">
                    âœ“ Complete Quest
                </button>
            </form>
            {% else %}
            <button class="btn-primary btn-large" disabled title="Complete at least 50% of subtasks">
                âœ“ Complete Quest ({{ status.completed }}/{{ status.total }} done)
            </button>
            {% endif %}
            <form method="POST" action="{{ url_for('delete_task_instance', instance_id=instance.id) }}" onsubmit="return confirm('Remove this task? (Cannot be undone)')" style="display: inline;">
                <button type="submit" class="btn-danger">
                    Remove Task
                </button>
            </form>
        {% else %}
            <div class="completed-banner">
                âœ¨ Quest Completed! +{{ instance.xp_earned }} XP
            </div>
        {% endif %}
        <a href="{{ url_for('dashboard') }}" class="btn-secondary">
            Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
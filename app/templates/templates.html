{% extends "base.html" %}

{% block title %}Templates - Conquer{% endblock %}

{% block content %}
<div class="templates-page">
    <h1>ðŸ“š Quest Templates</h1>
    <p class="subtitle">Choose a template and select your energy level to add it to today</p>

    <!-- Filters -->
    <div class="templates-filters">
        <a href="{{ url_for('templates_list') }}" 
           class="filter-link {% if not selected_category %}active{% endif %}">
            All Categories
        </a>
        {% for category in categories %}
        <a href="{{ url_for('templates_list', category=category) }}" 
           class="filter-link {% if selected_category == category %}active{% endif %}">
            {{ category }}
        </a>
        {% endfor %}
    </div>

    <!-- Templates Grid -->
    <div class="templates-grid">
        {% if templates %}
            {% for template in templates %}
            <div class="template-card">
                <div class="template-header">
                    <h3>{{ template.title }}</h3>
                    <span class="template-category">{{ template.category }}</span>
                </div>
                
                <div class="template-info">
                    <div class="template-tags">
                        <span class="tag tag-type">{{ template.task_type }}</span>
                        {% if template.effort_type %}
                        <span class="tag tag-effort">{{ template.effort_type }}</span>
                        {% endif %}
                        {% if template.location_type %}
                        <span class="tag tag-location">{{ template.location_type }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="template-subtasks">
                        <strong>{{ template.subtasks|length }} subtasks:</strong>
                        <ul>
                            {% for subtask in template.subtasks[:3] %}
                            <li>
                                <span class="subtask-level">L{{ subtask.level }}</span>
                                {{ subtask.description }}
                            </li>
                            {% endfor %}
                            {% if template.subtasks|length > 3 %}
                            <li class="more-indicator">+ {{ template.subtasks|length - 3 }} more...</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                
                <div class="template-actions">
                    <div class="tier-selector">
                        <p class="tier-prompt">Choose your energy:</p>
                        <div class="tier-buttons">
                            <button class="tier-btn low" onclick="addTemplateToToday({{ template.id }}, 1)">
                                ðŸŒ™ Low<br><span class="tier-xp">~{{ template.base_xp_low }} XP</span>
                            </button>
                            <button class="tier-btn medium" onclick="addTemplateToToday({{ template.id }}, 2)">
                                âš¡ Medium<br><span class="tier-xp">~{{ template.base_xp_medium }} XP</span>
                            </button>
                            <button class="tier-btn high" onclick="addTemplateToToday({{ template.id }}, 3)">
                                ðŸ”¥ High<br><span class="tier-xp">~{{ template.base_xp_high }} XP</span>
                            </button>
                        </div>
                    </div>
                    
                    <a href="{{ url_for('edit_template', template_id=template.id) }}" class="btn-secondary btn-small">
                        Edit Template
                    </a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state-large">
                <p>No templates found.</p>
                <a href="{{ url_for('create_template') }}" class="btn-primary">Create Your First Template</a>
            </div>
        {% endif %}
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
function addTemplateToToday(templateId, tier) {
    fetch(`/template/${templateId}/add`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tier: tier })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            // Redirect to the new task instance after a brief delay
            setTimeout(() => {
                window.location.href = `/task/${data.instance_id}`;
            }, 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error adding task', 'error');
    });
}
</script>
{% endblock %}